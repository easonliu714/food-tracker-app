import { getLocales } from 'expo-localization';
import { useState, useEffect } from 'react';
import { getSettings, saveSettings } from './storage';

export const LANGUAGES = [
  { code: 'zh-TW', label: '繁體中文' },
  { code: 'en', label: 'English' },
  { code: 'ja', label: '日本語' },
  { code: 'ko', label: '한국어' },
  { code: 'fr', label: 'Français' },
  { code: 'ru', label: 'Русский' },
];

export const TRANSLATIONS = {
  'zh-TW': {
    // Tab Titles
    tab_home: '首頁',
    tab_analysis: '分析',
    tab_ai_coach: 'AI教練',
    tab_settings: '設定',
    
    // Common
    activity_level: '活動量',
    sedentary: '久坐 (BMR x 1.2)',
    lightly_active: '輕度 (BMR x 1.375)',
    moderately_active: '中度 (BMR x 1.55)',
    very_active: '高度 (BMR x 1.725)',
    gender: '性別',
    male: '男',
    female: '女',
    birth_year: '出生西元年',
    height: '身高(cm)',
    weight: '體重(kg)',
    body_fat: '體脂率(%)',
    target_weight: '目標(kg)',
    training_goal: '訓練目標',
    goal_maintain: '維持身形',
    goal_fat_loss: '降低體脂',
    goal_tone_up: '強化塑身',
    goal_upper_strength: '增加上半身肌力',
    goal_lower_strength: '增加下半身肌力',

    save_settings: '儲存設定',
    logout: '登出',
    version_history: '版次歷程',
    ai_settings: 'AI 設定',
    current_model: '目前使用模型',
    test_key: '測試並取得模型',
    api_key_placeholder: '請貼上您的 API Key',
    trend_analysis: '趨勢分析',
    intake: '攝取',
    burned: '消耗',
    protein: '蛋',
    carbs: '碳',
    fat: '油',
    sodium: '鈉',
    week: '周',
    month_day: '月(日)',
    month_week: '月(週)',
    year: '年',
    manual_input: '手輸',
    photo: '拍照',
    scan: '掃碼',
    workout: '運動',
    today_overview: '今日概覽',
    quick_record: '快速紀錄',
    no_record: '尚無紀錄',
    ai_coach: 'AI 智能教練',
    recipe_suggestion: '食譜建議',
    workout_suggestion: '運動建議',
    generate_plan: '生成計畫',
    remaining_budget: '目前剩餘額度',
    watch_video: '觀看教學影片',
    ingredients: '食材',
    steps: '步驟',
    reason: '建議原因',
    estimated_weight: '估計重量 (g)',
    confirm_save: '確認並儲存',
    food_name: '食物名稱',
    calories: '熱量',
    suggestion_limit: '每日建議攝取量',
    alert_over: '超過建議值',
    export_pdf: '匯出 PDF',
    edit: '編輯',
    delete: '刪除',
    
    // New
    serving_weight: '每份重量 (g)',
    per_100g_base: '每 100g 基準數值',
    ai_analysis_result: 'AI 分析結果',
    composition: '組成',
    intake_advice: '攝取建議',
    scan_failed: '查無資料',
    scan_failed_msg: '本地與雲端資料庫皆無此商品，請選擇輸入方式：',
    scan_ai_label: 'AI 辨識標示',
    input_manual: '手動輸入',
  },
  'en': {
    tab_home: 'Home',
    tab_analysis: 'Analysis',
    tab_ai_coach: 'AI Coach',
    tab_settings: 'Settings',

    activity_level: 'Activity Level',
    sedentary: 'Sedentary',
    lightly_active: 'Lightly Active',
    moderately_active: 'Moderately Active',
    very_active: 'Very Active',
    gender: 'Gender',
    male: 'Male',
    female: 'Female',
    birth_year: 'Birth Year',
    height: 'Height (cm)',
    weight: 'Weight (kg)',
    body_fat: 'Body Fat (%)',
    target_weight: 'Target (kg)',
    training_goal: 'Training Goal',
    goal_maintain: 'Maintain',
    goal_fat_loss: 'Fat Loss',
    goal_tone_up: 'Tone Up',
    goal_upper_strength: 'Upper Strength',
    goal_lower_strength: 'Lower Strength',

    save_settings: 'Save Settings',
    logout: 'Logout',
    version_history: 'Version History',
    ai_settings: 'AI Settings',
    current_model: 'Current Model',
    test_key: 'Test & Get Models',
    api_key_placeholder: 'Paste your API Key here',
    trend_analysis: 'Trend Analysis',
    intake: 'Intake',
    burned: 'Burned',
    protein: 'Prot',
    carbs: 'Carb',
    fat: 'Fat',
    sodium: 'Sod',
    week: 'Week',
    month_day: 'Month(Day)',
    month_week: 'Month(Week)',
    year: 'Year',
    manual_input: 'Manual',
    photo: 'Photo',
    scan: 'Scan',
    workout: 'Workout',
    today_overview: 'Today Overview',
    quick_record: 'Quick Add',
    no_record: 'No records',
    ai_coach: 'AI Coach',
    recipe_suggestion: 'Recipe',
    workout_suggestion: 'Workout',
    generate_plan: 'Generate Plan',
    remaining_budget: 'Remaining Budget',
    watch_video: 'Watch Video',
    ingredients: 'Ingredients',
    steps: 'Steps',
    reason: 'Reason',
    estimated_weight: 'Est. Weight (g)',
    confirm_save: 'Confirm & Save',
    food_name: 'Food Name',
    calories: 'Calories',
    suggestion_limit: 'Daily Suggestion',
    alert_over: 'Exceeded',
    export_pdf: 'Export PDF',
    edit: 'Edit',
    delete: 'Delete',
    
    serving_weight: 'Serving Weight (g)',
    per_100g_base: 'Per 100g Base',
    ai_analysis_result: 'AI Analysis',
    composition: 'Composition',
    intake_advice: 'Advice',
    scan_failed: 'Not Found',
    scan_failed_msg: 'Product not found. Choose input method:',
    scan_ai_label: 'AI Label Scan',
    input_manual: 'Manual Input',
  },
  'ja': {
    tab_home: 'ホーム',
    tab_analysis: '分析',
    tab_ai_coach: 'AIコーチ',
    tab_settings: '設定',

    activity_level: '活動レベル',
    sedentary: '座りっぱなし',
    lightly_active: '軽い運動',
    moderately_active: '中程度の運動',
    very_active: '激しい運動',
    extra_active: '非常に激しい',
    gender: '性別',
    male: '男性',
    female: '女性',
    birth_year: '生まれ年',
    height: '身長(cm)',
    weight: '体重(kg)',
    body_fat: '体脂肪率(%)',
    target_weight: '目標体重(kg)',
    goal: '目標',
    lose_weight: '減量',
    maintain: '維持',
    gain_weight: '増量',
    daily_target: '1日の目標',
    save_settings: '設定を保存',
    logout: 'ログアウト',
    version_history: 'バージョン履歴',
    ai_settings: 'AI設定',
    current_model: '現在のモデル',
    test_key: 'テストして取得',
    api_key_placeholder: 'APIキーを入力',
    trend_analysis: '傾向分析',
    intake: '摂取',
    burned: '消費',
    protein: 'タンパク質',
    carbs: '炭水化物',
    fat: '脂質',
    sodium: 'ナトリウム',
    week: '週',
    month_day: '月(日)',
    month_week: '月(週)',
    year: '年',
    manual_input: '手入力',
    photo: '写真',
    scan: 'スキャン',
    workout: '運動',
    today_overview: '今日の概要',
    quick_record: 'クイック記録',
    no_record: '記録なし',
    ai_coach: 'AIコーチ',
    recipe_suggestion: 'レシピ提案',
    workout_suggestion: '運動提案',
    generate_plan: 'プラン作成',
    remaining_budget: '残り予算',
    watch_video: '動画を見る',
    ingredients: '材料',
    steps: '手順',
    reason: '理由',
    estimated_weight: '推定重量(g)',
    confirm_save: '保存する',
    food_name: '食品名',
    calories: 'カロリー',
    suggestion_limit: '推奨摂取量',
    alert_over: '超過',
    export_pdf: 'PDF出力',
    edit: '編集',
    delete: '削除',
  },
  'ko': {
    tab_home: '홈',
    tab_analysis: '분석',
    tab_ai_coach: 'AI 코치',
    tab_settings: '설정',

    activity_level: '활동 수준',
    sedentary: '좌식 생활',
    lightly_active: '가벼운 활동',
    moderately_active: '보통 활동',
    very_active: '활발한 활동',
    extra_active: '매우 활발함',
    gender: '성별',
    male: '남성',
    female: '여성',
    birth_year: '출생년도',
    height: '키(cm)',
    weight: '체중(kg)',
    body_fat: '체지방률(%)',
    target_weight: '목표 체중(kg)',
    goal: '목표',
    lose_weight: '체중 감량',
    maintain: '유지',
    gain_weight: '체중 증량',
    daily_target: '일일 목표',
    save_settings: '설정 저장',
    logout: '로그아웃',
    version_history: '버전 기록',
    ai_settings: 'AI 설정',
    current_model: '현재 모델',
    test_key: '테스트 및 모델 가져오기',
    api_key_placeholder: 'API 키 입력',
    trend_analysis: '추세 분석',
    intake: '섭취',
    burned: '소모',
    protein: '단백질',
    carbs: '탄수화물',
    fat: '지방',
    sodium: '나트륨',
    week: '주',
    month_day: '월(일)',
    month_week: '월(주)',
    year: '년',
    manual_input: '직접 입력',
    photo: '촬영',
    scan: '스캔',
    workout: '운동',
    today_overview: '오늘의 개요',
    quick_record: '빠른 기록',
    no_record: '기록 없음',
    ai_coach: 'AI 코치',
    recipe_suggestion: '레시피 제안',
    workout_suggestion: '운동 제안',
    generate_plan: '계획 생성',
    remaining_budget: '남은 예산',
    watch_video: '영상 보기',
    ingredients: '재료',
    steps: '단계',
    reason: '이유',
    estimated_weight: '예상 중량(g)',
    confirm_save: '확인 및 저장',
    food_name: '음식 이름',
    calories: '칼로리',
    suggestion_limit: '권장 섭취량',
    alert_over: '초과',
    export_pdf: 'PDF 내보내기',
    edit: '편집',
    delete: '삭제',
  },
  'fr': {
    tab_home: 'Accueil',
    tab_analysis: 'Analyse',
    tab_ai_coach: 'Coach IA',
    tab_settings: 'Paramètres',

    activity_level: "Niveau d'activité",
    sedentary: 'Sédentaire',
    lightly_active: 'Légèrement actif',
    moderately_active: 'Modérément actif',
    very_active: 'Très actif',
    extra_active: 'Extrêmement actif',
    gender: 'Sexe',
    male: 'Homme',
    female: 'Femme',
    birth_year: 'Année de naissance',
    height: 'Taille (cm)',
    weight: 'Poids (kg)',
    body_fat: 'Graisse (%)',
    target_weight: 'Cible (kg)',
    goal: 'Objectif',
    lose_weight: 'Perdre du poids',
    maintain: 'Maintenir',
    gain_weight: 'Prendre du poids',
    daily_target: 'Objectif quotidien',
    save_settings: 'Enregistrer',
    logout: 'Se déconnecter',
    version_history: 'Historique',
    ai_settings: 'Paramètres IA',
    current_model: 'Modèle actuel',
    test_key: 'Tester',
    api_key_placeholder: 'Entrez votre clé API',
    trend_analysis: 'Tendances',
    intake: 'Apport',
    burned: 'Brûlé',
    protein: 'Prot',
    carbs: 'Gluc',
    fat: 'Lip',
    sodium: 'Sod',
    week: 'Sem',
    month_day: 'Mois(J)',
    month_week: 'Mois(S)',
    year: 'Année',
    manual_input: 'Manuel',
    photo: 'Photo',
    scan: 'Scan',
    workout: 'Sport',
    today_overview: "Aperçu d'aujourd'hui",
    quick_record: 'Ajout rapide',
    no_record: 'Aucun enreg.',
    ai_coach: 'Coach IA',
    recipe_suggestion: 'Recette',
    workout_suggestion: 'Sport',
    generate_plan: 'Générer',
    remaining_budget: 'Budget restant',
    watch_video: 'Voir la vidéo',
    ingredients: 'Ingrédients',
    steps: 'Étapes',
    reason: 'Raison',
    estimated_weight: 'Poids est. (g)',
    confirm_save: 'Confirmer',
    food_name: 'Nom',
    calories: 'Calories',
    suggestion_limit: 'Conseillé',
    alert_over: 'DÉPASSÉ',
    export_pdf: 'Exporter PDF',
    edit: 'Éditer',
    delete: 'Supprimer',
  },
  'ru': {
    tab_home: 'Главная',
    tab_analysis: 'Анализ',
    tab_ai_coach: 'AI Тренер',
    tab_settings: 'Настройки',

    activity_level: 'Активность',
    sedentary: 'Сидячий',
    lightly_active: 'Малоактивный',
    moderately_active: 'Умеренно',
    very_active: 'Активный',
    extra_active: 'Экстремально',
    gender: 'Пол',
    male: 'Муж',
    female: 'Жен',
    birth_year: 'Год рожд.',
    height: 'Рост (см)',
    weight: 'Вес (кг)',
    body_fat: 'Жир (%)',
    target_weight: 'Цель (кг)',
    goal: 'Цель',
    lose_weight: 'Похудение',
    maintain: 'Поддержание',
    gain_weight: 'Набор',
    daily_target: 'Цель дня',
    save_settings: 'Сохранить',
    logout: 'Выйти',
    version_history: 'История',
    ai_settings: 'Настройки ИИ',
    current_model: 'Модель',
    test_key: 'Тест',
    api_key_placeholder: 'Ваш API ключ',
    trend_analysis: 'Тренды',
    intake: 'Потребл.',
    burned: 'Сожжено',
    protein: 'Белки',
    carbs: 'Углев',
    fat: 'Жиры',
    sodium: 'Натрий',
    week: 'Нед',
    month_day: 'Мес(Д)',
    month_week: 'Мес(Н)',
    year: 'Год',
    manual_input: 'Вручную',
    photo: 'Фото',
    scan: 'Скан',
    workout: 'Спорт',
    today_overview: 'Обзор дня',
    quick_record: 'Быстро',
    no_record: 'Нет записей',
    ai_coach: 'ИИ Тренер',
    recipe_suggestion: 'Рецепт',
    workout_suggestion: 'Тренировка',
    generate_plan: 'Создать',
    remaining_budget: 'Остаток',
    watch_video: 'Видео',
    ingredients: 'Ингредиенты',
    steps: 'Шаги',
    reason: 'Причина',
    estimated_weight: 'Вес (г)',
    confirm_save: 'Сохранить',
    food_name: 'Еда',
    calories: 'Ккал',
    suggestion_limit: 'Норма',
    alert_over: 'ПРЕВЫШЕНО',
    export_pdf: 'Экспорт PDF',
    edit: 'Изменить',
    delete: 'Удалить',
  },
};


export const VERSION_LOGS = [
  { version: '1.0.6', date: '2025-12-23', content: '新增訓練目標與年齡推算；強化 AI 教練建議邏輯；優化掃碼功能(支援外部資料庫查詢)；食物確認頁面改版(分離基準值)。' },
  { version: '1.0.5', date: '2025-12-22', content: '修復推播導致的閃退問題；優化運動熱量計算公式；新增營養素攝取比例圖表。' },
  { version: '1.0.4', date: '2025-12-21', content: 'UI/UX全面優化：解決語言切換延遲問題；新增相簿匯入功能；AI教練建議分開儲存；鈉含量單位修正。' },
  { version: '1.0.3', date: '2025-12-20', content: '新增多語言支援；新增體脂率紀錄；趨勢分析增加年/月/週切換；AI 邏輯優化。' },
  { version: '1.0.2', date: '2025-12-18', content: '修正 AI 金鑰失效問題，開放自訂 Key；修正條碼掃描；優化趨勢圖表。' },
  { version: '1.0.1', date: '2025-12-15', content: '基本功能發布：飲食紀錄、卡路里計算、個人檔案、AI 辨識、條碼掃描。' },
];

export const t = (key: string, lang: string = 'zh-TW') => {
  const dict = TRANSLATIONS[lang as keyof typeof TRANSLATIONS] || TRANSLATIONS['en'];
  return dict[key as keyof typeof dict] || TRANSLATIONS['zh-TW'][key as any] || key;
};

const listeners: ((lang: string) => void)[] = [];

export const subscribeLanguageChange = (callback: (lang: string) => void) => {
  listeners.push(callback);
  return () => {
    const index = listeners.indexOf(callback);
    if (index > -1) listeners.splice(index, 1);
  };
};

let currentLang = 'zh-TW';

export const getCurrentLang = () => currentLang;

export const setAppLanguage = (lang: string) => {
  currentLang = lang;
  listeners.forEach(cb => cb(lang));
  saveSettings({ language: lang });
};

export const useLanguage = () => {
  const [lang, setLang] = useState(currentLang);
  useEffect(() => {
    getSettings().then(s => { 
      if(s.language && s.language !== currentLang) {
        currentLang = s.language;
        setLang(s.language);
      }
    });
    return subscribeLanguageChange(setLang);
  }, []);
  return lang;
};